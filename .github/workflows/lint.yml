name: Lint Filter Lists

on:
  push:
    branches:
      - master
    paths:
      - "**/*.txt"
  pull_request:
    branches:
      - master
    paths:
      - "**/*.txt"

permissions:
  contents: write
  pull-requests: write

jobs:
  fop:
    name: Run FOP to check and fix ordering
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Fetch PR branch
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch
          git checkout pr-branch

      - name: Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin master --depth=2
            FILES=$(git diff --name-only origin/master HEAD -- '*.txt' | tr '\n' ' ')
          else
            FILES=$(git diff --name-only HEAD~1 -- '*.txt' | tr '\n' ' ')
          fi
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $FILES"

      - name: Run FOP
        if: steps.changed.outputs.files != ''
        run: |
          chmod +x fop-linux
          for file in ${{ steps.changed.outputs.files }}; do
            if [ -f "$file" ]; then
              echo "Sorting: $file"
              ./fop-linux --no-commit --check-file="$file"
            fi
          done

      - name: Commit fixes if PR
        if: github.event_name == 'pull_request'
        run: |
          if git diff --quiet; then
            echo "No changes needed"
          else
            echo "Committing sorted files..."
            git config --global user.email "github-actions@github.com"
            git config --global user.name "GitHub Actions"
            git add -A
            git commit -m "M: Auto-sort filter lists"
            # Push to the actual PR branch
            git push origin pr-branch:${{ github.head_ref }} || {
              echo "::error::Cannot push to fork PR. Please run FOP locally and commit."
              exit 1
            }
          fi

      - name: Fail on push if unsorted
        if: github.event_name == 'push'
        run: |
          if ! git diff --quiet; then
            echo "Files are not sorted!"
            git diff --stat
            exit 1
          fi

  aglint:
    name: Run AGLint
    runs-on: ubuntu-latest
    steps: 
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      - name: Check out to repository
        uses: actions/checkout@v4
      - name: Install npm dependencies
        run: npm i --verbose || (sleep 15 && npm i --verbose) || (sleep 30 && npm i --verbose)
        shell: bash
      - name: Run AGLint
        run: npm run aglint
        shell: bash
